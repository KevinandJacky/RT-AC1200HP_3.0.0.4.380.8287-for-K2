var m=new lang,g_storage=new myStorage,g_this_video="",g_this_video_name="",g_this_video_hash="",g_play_id=-1,g_subtitle_timer=0,g_isIE=!1,g_video_player_type="none";
function detectVLCInstalled(){navigator.userAgent.toLowerCase();var b=!1;if(g_isIE){var a=null;try{a=new ActiveXObject("VideoLAN.Vlcplugin")}catch(c){var d="An exception occurred while trying to create the object VideoLAN.VLCPlugin.1:\n";for(p in c)d+="e."+p+"= "+c[p]+"\n"}null!=a&&(b=!0)}else if(navigator.plugins&&navigator.plugins.length)for(a=0;a<navigator.plugins.length;a++)if(d=navigator.plugins[a],d.name.indexOf("VideoLAN")>-1||d.name.indexOf("VLC")>-1)b=!0;return b}
function getInternetExplorerVersion(){var b=-1;navigator.appName=="Microsoft Internet Explorer"&&/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)!=null&&(b=parseFloat(RegExp.$1));return b}function closeWindow(){parent.closeJqmWindow(0)}$(document).keydown(function(b){if(b.keyCode==27)return!1});function init(){setTimeout(function(){createPlayer()},500)}
function monitor(){if(getPlayer("videoPlayer")!=null){var b=getCurrentTime(),a=getTotalTime();g_video_player_type=="vlc"&&b>=a&&doStop();a>0&&($(".currTime").text(formatTime(b)),$(".totalTime").text(formatTime(a)),b=b/a*$(".playbar .slider-tracker").width(),$(".playbar .slider-thumb").css("left",b),$(".playbar .slider-progress").css("width",b));record_playtime()}}
function formatTime(b){if(typeof b!="number")return"-:--:--";var b=Math.round(b),a=b%60;a<10&&(a="0"+a);var b=(b-a)/60,c=b%60;c<10&&(c="0"+c);b=(b-c)/60;return b>0?b+":"+c+":"+a:c+":"+a}function getCurrentTime(){var b=getPlayer("videoPlayer");if(b==null)return 0;var a=0;g_video_player_type=="html5"?a=b.currentTime:g_video_player_type=="vlc"&&(a=b.input.time/1E3);return a}
function getTotalTime(){var b=getPlayer("videoPlayer");if(b==null)return 0;var a=0;g_video_player_type=="html5"?a=b.duration:g_video_player_type=="vlc"&&(a=b.input.length/1E3);return a}function doPlay(){var b=getPlayer("videoPlayer");b!=null&&(g_video_player_type=="html5"?(b.play(),$("#btn_play").hide(),$("#btn_pause").show()):g_video_player_type=="vlc"&&(b.playlist.play(),$("#btn_play").hide(),$("#btn_pause").show()))}
function doPause(){var b=getPlayer("videoPlayer");b!=null&&(g_video_player_type=="html5"?(b.pause(),$("#btn_play").show(),$("#btn_pause").hide()):g_video_player_type=="vlc"&&(g_isIE?b.playlist.stop():b.playlist.pause(),$("#btn_play").show(),$("#btn_pause").hide()))}
function doStop(){var b=getPlayer("videoPlayer");b!=null&&(g_video_player_type=="html5"?(b.pause(),$("#btn_play").show(),$("#btn_pause").hide()):g_video_player_type=="vlc"&&(b.playlist.stop(),$("#btn_play").show(),$("#btn_pause").hide()))}function record_playtime(){var b=getCurrentTime(),a=getTotalTime();b>=a?g_storage.setl(g_this_video_hash,0):g_storage.setl(g_this_video_hash,b)}
function doAspectRatio(){var b=getPlayer("videoPlayer");if(b!=null&&g_video_player_type!="html5"&&g_video_player_type=="vlc")b.video.aspectRatio=$("#select_aspect").val()}
function play_subtitle(){getPlayer("videoPlayer")!=null&&$(".srt").each(function(){var b=function(a){var b=0;if(a){a=a.split(":");for(i=0;i<a.length;i++)b=b*60+parseFloat(String(a[i]==null?"":a[i]).replace(",","."))}return b},a=function(a){return String(a==null?"":a).replace(/^\s+|\s+$/g,"")},c=function(a){var b=[],c;for(c in a)b.push(c);b.sort();c=[];for(var k=0;k<b.length;k++)c[b[k]]=a[b[k]];return c},d=function(d){var e=d.text();d.text("");var e=e.replace(/\r\n|\r|\n/g,"\n"),g={},e=String(a(e)),
k=1,e=e.split("\n\n");for(s in e)if(st=String(e[s]).split("\n"),st.length>=2){n=st[0];i=a(st[1].split(" --\> ")[0]);o=a(st[1].split(" --\> ")[1]);t=st[2];if(st.length>2)for(j=3;j<st.length;j++)t+="\n"+st[j];is=b(i);os=b(o);g[k]={is:is,i:i,o:o,t:t};k++}g=c(g);g.length>0&&($(".subtitle").show(),adjustVideoSize());var q=-1;g_subtitle_timer=setInterval(function(){var a=getCurrentTime(),b=-1,c;for(c in g){if(g[c].is>a)break;b=c}b>0?b!=q?(d.text(g[b].t),q=b):g[b].o<a&&d.text(""):d.text("")},100)},f=$(this);
clearInterval(g_subtitle_timer);var e=f.attr("data-srt");e?$(this).load(e,function(){d(f)}):(f.text(""),$(".subtitle").hide(),adjustVideoSize())})}function adjustVideoSize(){var b=getPlayer("videoPlayer");if(b!=null){var a=$(window).width(),c=$(window).height();$(".toolbar").is(":visible")&&(c-=$(".toolbar").height());$(".footer").is(":visible")&&(c-=$(".footer").height());$(".subtitle").is(":visible")&&(c-=$(".subtitle").height());b.style.width=a+"px";b.style.height=c+"px"}}
function getPlayer(b){return document.getElementById(b)}
function initPlayer(){var b=getPlayer("videoPlayer");if(b!=null){var a=getUrlVars(),c=a.u,d=a.v,a=a.s==void 0?"":a.s;if(a!=""){for(var c=a.split(";"),f=!1,e="<option value=''>"+m.getString("title_no_subtitle")+"</option>",a=0;a<c.length;a++){var h=c[a];if(h!=""){var h=h.substr(h.lastIndexOf("/")+1,h.length),l=window.location.protocol+"//"+window.location.host+c[a];e+="<option value='"+l+"'";h.indexOf(g_this_video_name)==0&&(e+="selected ",$(".subtitle").attr("data-srt",l));e+=">"+h+"</option>";f=
!0}}$(e).appendTo($("#select_subtitle"));$(".subtitle-ctrl").css("display",f?"block":"none");$("#select_subtitle").change(function(){$(".subtitle").attr("data-srt",$(this).val());play_subtitle()});play_subtitle()}else f=!1,e="<option value=''>"+m.getString("title_no_subtitle")+"</option>",a=new davlib.DavClient,a.initialize(),a.GETVIDEOSUBTITLE(c,g_this_video_name,function(a,b,c){a==200&&(a=parseXml(c),$(a).find("file").each(function(){var a=$(this).find("name").text(),b=window.location.protocol+
"//"+window.location.host+"/"+$(this).find("sharelink").text();e+="<option value='"+b+"'";a.indexOf(g_this_video_name)==0&&(e+="selected ",$(".subtitle").attr("data-srt",b));e+=">"+a+"</option>";f=!0}),$(e).appendTo($("#select_subtitle")),$(".subtitle-ctrl").css("display",f?"block":"none"),$("#select_subtitle").change(function(){$(".subtitle").attr("data-srt",$(this).val());play_subtitle()}),play_subtitle())}),a=null;if(g_video_player_type=="html5")$("#videoPlayer").on("ended",function(){doStop()});
else if(g_video_player_type=="vlc"){if(g_play_id=b.playlist.add(d),g_play_id==-1){alert("cannot play at the moment !");return}}else{alert("Not supported player");return}d=parseInt($(".volumebar .slider-progress").css("left"));$(".volumebar .slider-thumb").css("left",37);$(".volumebar .slider-progress").css("width",37-d);doPlay();setInterval("monitor()",1E3);d=g_storage.getl(g_this_video_hash);if(d!=void 0&&d!=0&&confirm(m.getString("msg_last_playtime")))if(g_video_player_type=="html5")b.currentTime=
d;else if(g_video_player_type=="vlc")b.input.time=d*1E3;$(".toolbar").show();$(".footer").show();adjustVideoSize();$("#btn_play").click(function(){doPlay()});$("#btn_pause").click(function(){doPause()});$("#btn_stop").click(function(){doStop()});$(".playbar .slider-thumb").draggable({axis:"x",snap:"true",cursor:"move",start:function(){},drag:function(a,b){var c=$(".playbar .slider-tracker").width();if(b.position.left<=0)b.position.left=0;if(b.position.left>=c)b.position.left=c;$(".playbar .slider-progress").css("width",
b.position.left)},stop:function(a,c){var d=getTotalTime(),e=0;d>0&&(e=c.position.left/$(".playbar .slider-tracker").width()*d);if(g_video_player_type=="html5")b.currentTime=e,b.play();else if(g_video_player_type=="vlc")b.input.time=e*1E3,b.playlist.play()}});$(".volumebar .slider-thumb").draggable({axis:"x",snap:"true",cursor:"move",drag:function(a,c){var d=parseInt($(".volumebar .slider-progress").css("left")),e=74-$(".volumebar .slider-thumb").width()+d;if(c.position.left<=d)c.position.left=d;if(c.position.left>=
e)c.position.left=e;$(".volumebar .slider-progress").css("width",c.position.left-d);if(g_video_player_type=="html5")d=c.position.left/74,b.volume=d;else if(g_video_player_type=="vlc")d=c.position.left/74*200,b.audio.volume=d},stop:function(a,c){if(g_video_player_type=="html5"){var d=c.position.left/74;b.volume=d}else if(g_video_player_type=="vlc")d=c.position.left/74*200,b.audio.volume=d}})}}
function createPlayer(){var b=getUrlVars(),a=String(window.navigator.userLanguage||window.navigator.language).toLowerCase(),a=g_storage.get("lan")==void 0?a:g_storage.get("lan");m.setLanguage(a);$("button#btnClose").text(m.getString("btn_close"));$("#label_subtitle").text(m.getString("title_subtitle_file")+": ");b=b.v;a="";g_this_video=b;g_this_video_name=b.substring(b.lastIndexOf("/")+1,b.lastIndexOf("."));g_this_video_hash=md5(g_this_video.substr(g_this_video.lastIndexOf("/")+1,g_this_video.length));
navigator.userAgent.toLowerCase();var c=navigator.appVersion.toLowerCase(),d=g_this_video.split(".").pop().toLowerCase();g_isIE=isIE();if(c.indexOf("mac")!=-1||d=="mp4")c=$(window).width(),d=$(window).height()-$(".footer").height(),a+="<div>",a+="<video id='videoPlayer' name='videoPlayer' width='"+c+"px' height='"+d+"px' autoplay>",a+="<source src='",a+=b,a+="' type='video/mp4'/>",a+="Your browser does not support the video tag.",a+="</video>",a+="</div>",g_video_player_type="html5";else if(g_isIE){if(!detectVLCInstalled()){c=
$(window).width();d=$(window).height()-$(".footer").height();a+="<div id='errorpage' class='section' style='width:"+c+"px; height:"+d+"px'>";a+="<img id='errorpage_bg' src='vlc_bg_img.jpg'/>";a+="<p style='position:relative;left:54px;top:60px;width:500px;font-size:20px;color:#ffffff'>"+m.getString("msg_installvlc")+"</p>";a+="<p style='position:relative;left:54px;top:80px;width:550px;font-size:16px;color:#ffffff;text-align:left'>"+m.getString("msg_installvlc2")+"</p>";a+="<p style='position:relative;left:216px;top:100px;width:350px;font-size:14px;color:#ffffff;text-align:left'>"+
m.getString("msg_installvlc3")+"</p>";a+="<a href='http://www.videolan.org/vlc/' target='_blank'><div style='width:123px;height:30px;background-image:url(downloadvlc.png);position:relative;left:456px;top:100px;cursor:pointer'></div></a>";a+="</div>";$(a).appendTo($(".videoplayer"));$(".subtitle").hide();$(".footer").show();return}a+="<div>";g_isIE?(a+="<OBJECT classid='clsid:9BE31822-FDAD-461B-AD51-BE1D1C159921'",a+=" codebase='http://download.videolan.org/pub/videolan/vlc/last/win32/axvlc.cab'",
a+=" id='videoPlayer' name='videoPlayer' width='655px' height='470px' events='True'>",a+="<param name='MRL' value='' />",a+="<param name='ShowDisplay' value='False'/>",a+="<param name='AutoLoop' value='False'/>",a+="<param name='AutoPlay' value='False'/>",a+="<param name='ToolBar' value='False'/>",a+="<param name='Volume' value='50' />",a+="<param name='StartTime' value='0' />",a+="</OBJECT>"):(a+="<embed type='application/x-vlc-plugin'",a+=" pluginspage='http://www.videolan.org'",a+=" width='655px' height='470px' id='videoPlayer' name='videoPlayer' version='VideoLAN.VLCPlugin.2' text='Waiting for video' Volume='50' toolbar='False' AutoPlay='False'/>");
a+="</div>";g_video_player_type="vlc"}else{alert("Can not play this video!");return}$(a).appendTo($("#video_player_section"));$(".subtitle").hide();$(".footer").show();initPlayer()};
